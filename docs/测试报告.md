# JourneyOn 后端 – 实战集成测试报告

## 测试范围
- PostgreSQL（账户/行程/会话/知识库等ORM模型）
- Redis（缓存、限流、连接健康）
- Qdrant（向量集合创建、写入、相似检索）
- Ollama（LLM聊天与嵌入、可选重排序）
- 后端关键接口链路：/api/health、/api/auth、/api/trips、/api/trips/{id}/kb_entries、/api/kb/search、/api/agent/chat

## 测试环境与配置
- 操作系统：Docker Desktop（Windows/WSL 环境）
- 启动方式：`docker-compose up -d`
- 关键服务与端口：
  - PostgreSQL: 5432（用户 app / 密码 secret / DB journeyon）
  - Redis: 6379
  - Qdrant: 6333（HTTP）
  - Ollama: 11434（HTTP）
  - Web API: 8000（FastAPI）

### 重要配置变更（已提交）
1. docker-compose.yml 新增 `ollama` 服务，并将后端 `OLLAMA_URL` 指向 `http://ollama:11434`，启用嵌入：`ENABLE_EMBEDDING=true`。
2. 为保证维度匹配，将嵌入模型设为 `mxbai-embed-large`（向量维度 1024），无需调整 `VECTOR_DIM`（仍为 1024）。
3. 关闭重排序：`OLLAMA_RERANK_ENABLED=false`（避免社区模型拉取不稳定）。
4. `web` 对 `ollama` 的依赖降为 `service_started`，避免等待健康检查导致 web 阻塞启动。

备注：Qdrant 官方镜像默认不包含 curl/wget，原 compose 中的健康检查命令会失败，导致容器显示 `unhealthy`。尽管如此，Qdrant 对外服务正常（/readyz 200）。`web` 已改为 `condition: service_started`，不受健康检查状态影响。

## 测试用例设计
- 健康检查
  - /api/health：验证 DB、Redis、Qdrant 联通性与报告字段
  - /api/kb/health：验证 Qdrant 集合就绪、嵌入后端、Redis
- 认证与基础数据
  - 注册/登录（用户名/邮箱），返回 JWT
  - 创建 Trip（最小必填字段）
- 知识库（KB）与向量检索
  - 创建 KB 条目（触发异步嵌入与 Qdrant upsert）
  - GET/POST 搜索：正常查询、空查询、过滤条件非法（400）
  - 限流场景：单位时间内多次请求，期望 429（Redis 可用）/退化为本地窗口计数（Redis 不可用）
- LLM 代理
  - /api/agent/chat：最小对话流闭环（需要 Ollama 可用且存在聊天模型）
  - SSE 与 Websocket（仅连通性与结构）

## 实际执行与结果

已在真实 Docker 环境中拉起基础服务，并使用本机 Ollama 完成全链路测试：

- PostgreSQL：`SELECT 1` 成功（可用）
- Redis：`PING` 成功（健康）
- Qdrant：`/readyz` 200（就绪）
- Ollama：通过 `host.docker.internal:11434` 访问本机服务，模型列表可见；使用 `qwen3:8b`（对话）与 `bge-m3:latest`（嵌入）完成联调

依赖自检结果（scripts/check_dependencies.py）：
- redis: ok connected
- qdrant: ok collection ready
- embedding: ok model reachable (bge-m3:latest)
- llm: ok responded: Pong! 🎉 ...

端到端集成测试（scripts/integration_test.py）：
- /api/health：返回 {db:true, redis:true, qdrant:true}
- 注册/登录：成功，返回 JWT
- 创建行程：成功，返回 trip_id=1
- KB 向量检索：创建条目后搜索命中，示例
  - data: [{id:1, title:"上海外滩夜景", similarity:0.7494}]
- 代理对话：返回结构化结果，包含 reply、stage_history、transition 等关键信息（reply 示例：“🧳 这是行前筹备建议。确认后可进入行中阶段。”）

## 发现问题与修复记录
1. Qdrant 健康检查脚本依赖 wget（容器内默认不存在）：
   - 现象：`docker ps` 显示 `unhealthy`，但 /readyz 正常
   - 影响：如 `depends_on` 设为 `service_healthy` 会阻塞 web 启动
   - 修复：`web` 侧改为 `condition: service_started`；如需健康检查可行，建议改为自定义 sidecar 或移除 qdrant 健康检查配置

2. Ollama/模型选择与维度匹配：
   - 风险：嵌入模型维度需与 Qdrant 集合 `VECTOR_DIM` 一致
   - 处理：将嵌入模型切换为 `mxbai-embed-large`（1024 维），与默认 `VECTOR_DIM=1024` 匹配，避免入库/检索报错

3. 重排序模型可用性：
   - 现象：`dengcao/bge-reranker-v2-m3` 可能无法在 Ollama 官方库直接拉取
   - 处理：默认关闭重排序（`OLLAMA_RERANK_ENABLED=false`）；后续如需开启，建议选用 Ollama 官方支持的 rerank 模型并更新配置

4. 依赖启动顺序：
   - 调整：`web` 依赖 `postgres/redis` 健康，`qdrant/ollama` 只要求 started，避免镜像/模型拉取阻塞核心 API 启动

5. 使用本机 Ollama 替代容器镜像：
   - 变更：移除 compose 中的 Ollama 服务，`OLLAMA_URL` 指向 `http://host.docker.internal:11434`
   - 清理：如曾拉取 `ollama/ollama` 镜像，已清除（不再占用磁盘）

## 性能与边界测试（方案）
- 向量索引吞吐：批量插入 1k/5k/10k KB 条目，观察嵌入并发（`EMBEDDING_CONCURRENCY`）与 Qdrant upsert 延迟
- 检索延迟：不同 top_k（10/50/100），是否存在 timeout 或内存飙升
- 限流可靠性：Redis 不可用时是否平滑退化到本地窗口；高并发下 429 比例与恢复情况
- 代理对话：长输入/空输入/异常字符；LLM 请求超时/重试链路

## 遗留风险评估
- Ollama 首次拉取镜像与模型时间较长，CI 环境需准备缓存/镜像镜像站加速
- 模型维度与集合配置需保持一致，后续更换模型请同步 `VECTOR_DIM`
- Qdrant 健康检查命令缺失导致 `unhealthy` 误报，建议移除或以侧车健康探针方式实现
- LLM 提供商可切换（Ollama / 智谱），请确保对应凭据与出口网络可用

## 结论与下一步
- 基础依赖（PostgreSQL/Redis/Qdrant）与本机 Ollama 已在真实环境完整通过
- 已完成 compose 修正（使用本机 Ollama）、模型与维度匹配、易错点加固
- 一键测试脚本可重复验证健康、认证、行程、KB、检索、代理对话全链路

建议：
- 如需开启重排序，可在本机拉取可用的 rerank 模型（当前已存在 `dengcao/bge-reranker-v2-m3:latest`），然后将 `OLLAMA_RERANK_ENABLED=true` 并在需要时启用
- 后续可按报告中的“性能与边界测试（方案）”扩展压测与回归
