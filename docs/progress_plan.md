# 项目进度与下一阶段计划（依据设计文档）

## 当前进度概览

- **核心接口完成度高**：按照前期阶段性开发计划中定义的阶段一、阶段二目标，认证、行程、任务、行程项、会话等 CRUD 接口全部上线，并通过 `pytest` 自动化测试覆盖主要业务流程。
- **知识库与向量检索**：根据后端设计要求，已实现 KB 条目的增删改查、异步向量生成（FastAPI Task）、Redis 缓存与精排可选的 `/api/kb/search`（支持 POST/GET，含 metadata filters 与 rerank）。
- **文件存储与报告管理**：结合后端设计对文件存储模块的描述，实现本地文件存储抽象、报告模型与 CRUD API，可为 Post-trip Agent 生成 PDF/图片报告做好准备。
- **审计日志闭环**：`audit_logs` 表、统一 `log_action` 服务与管理员查询端点 `/api/audit-logs` 均已就绪，关键业务写操作均记录审计轨迹，满足安全与合规要求。
- **统一 LLM 接入层**：新增 `LLMClient` 支持 Ollama/Zhipu 切换，`/api/agent/chat`、SSE 与 WebSocket 均走统一异步链路并带 run_id/usage 追踪。
- **可配置化 Embedding/RAG**：内置异步 Ollama Embedding、可选精排模型、Redis 限流/缓存与健康检查，后续可扩展至 OpenAI 或其他后端。

## 待完善 / 风险点

- **LangGraph 智能体编排尚未落地**：虽已连通真实 LLM，但仍缺少多工具编排、记忆注入与任务拆解流程。
- **会话上下文缓存**：虽然已引入 Redis 包装，但对话上下文及阶段性记忆尚未完整接入缓存层，与《后端设计方案.md》提出的“缓存会话上下文”仍有差距。
- **工具调用与上下文记忆**：需要引入真实工具（天气/航班等）并把 Redis 作为对话上下文缓存，才能达成多轮推理目标。
- **监控与运维**：尚未实现 Prometheus 指标、结构化日志外的监控告警，部署流程仍停留在 docker-compose 草案阶段。

## 下一阶段详细计划

1. **完成阶段三目标：多工具智能体编排**：
   - 在 `app/agents/orchestrator.py` 中接入 LangGraph/工具节点，根据行程阶段调度天气、酒店、航班、POI 服务；落地工具权限校验与异常兜底。
   - 将 Redis conversation 缓存与行程上下文注入到 LLM 提示词，实现多轮记忆与 run_id 追踪。
   - 扩展 `/api/agent/chat` 响应结构，包含工具调用事件、建议任务/行程项列表并写入审计日志。

2. **知识库持续演进**：
   - 支持批量向量导入、重建索引与定期压缩；为 rerank 增加超时/降级策略与模型指标上报。
   - 引入 Post-trip 报告生成所需的 RAG 组合（搜索结果 + 模板生成），串联 audit trail。

3. **缓存与只读性能优化**：
   - 对行程详情、任务列表等接口增加 Redis 只读缓存与失效策略；缓存命中统计纳入监控。
   - 设计 conversation/token 消耗指标，落地限流与报警阈值。

4. **运维与监控体系**：
   - 增加 Prometheus 指标导出端点（请求计数、错误率、依赖服务健康等）。
   - 在 docker-compose 中补齐 Redis、Qdrant、MinIO 依赖的默认配置，编写部署手册与健康检查脚本。
   - 考虑引入 Sentry/OpenTelemetry，满足《后端设计方案.md》第 12 章的监控要求。

5. **安全与多租户增强**：
   - 审计日志查询增加分页游标与时间范围过滤。
   - 在《技术选型方案.md》建议下，评估 JWT 刷新机制与密码找回流程。

按以上计划推进，可在保持现有 API 稳定性的同时，逐步实现设计文档中关于智能体、多模态报告与高可用部署的目标。
