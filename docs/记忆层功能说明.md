# JourneyOn 记忆层（mem0）功能说明

## 概述
记忆层用于在用户维度沉淀对话内容、长期偏好与上下文事实，为各阶段智能体与工具提供可检索的语义记忆。系统通过 `MemoryService` 对 mem0 进行轻封装，保证：
- 统一配置与连接（与 Qdrant、Ollama/OpenAI 嵌入一致）；
- 可选开关（禁用时安全降级为无结果）；
- 避免异常向上冒泡（服务端兜底）。

## 启用与配置
- 环境变量（本地推荐）：
  - `MEMORY_ENABLED=true` 开启记忆层
  - `MEMORY_INFER=false` 是否由记忆层在写入时自动提炼结构化记忆
  - `MEMORY_COLLECTION_NAME=memories` 向量集合名
  - `VECTOR_DIM=1024` 向量维度（需与嵌入模型匹配）
  - `EMBEDDING_PROVIDER=ollama|openai` 嵌入提供商
  - `OLLAMA_URL=http://localhost:11434`（本机 Ollama）
  - `OLLAMA_EMBED_MODEL=bge-m3:latest`（默认 1024 维）
  - `QDRANT_URL=http://localhost:6333`
  - `MEM0_DISABLE_TELEMETRY=true`（可选）

- Docker Compose：默认关闭 Memory（`MEMORY_ENABLED=false`），建议在本地开发时启用并运行 API 进行验证。

## 服务封装（Python）
- 入口：`app/services/memory_service.py`
- 主要方法：
  - `add_messages(messages, *, user_id, agent_id=None, run_id=None, metadata=None, infer=None) -> dict | None`
  - `search(query, *, top_k=10, filters=None, threshold=None) -> list[dict]`
  - `get(memory_id) -> dict | None`
  - `update(memory_id, text) -> dict | None`
  - `delete(memory_id) -> dict | None`
  - `delete_all(filters: dict) -> dict | None`
  - `history(memory_id) -> list[dict]`
- 容错：当 `MEMORY_ENABLED=false` 或底层抛出异常时返回 `None/[]`，不影响上层流程。

## REST API（FastAPI）
- 路由前缀：`/api/memories`
- 端点列表：
  - `POST /add`：写入对话消息数组。请求体：`{messages:[{role,content,name?}], metadata?, agent_id?, run_id?, infer?}`
  - `POST /search`：语义检索。请求体：`{query, top_k?, threshold?, filters?}`
  - `GET /search`：语义检索（query 参数 + 可选 filters JSON）
  - `GET /{memory_id}`：按 id 获取
  - `PUT /{memory_id}`：更新文本 `{"text": "..."}`
  - `DELETE /{memory_id}`：删除
  - `GET /{memory_id}/history`：事件历史
  - `POST /delete_all`：按过滤条件批量删除。请求体：`{filters: {...}}`
- 安全：
  - 所有接口需 Bearer Token；
  - 搜索/删除默认注入 `user_id` 过滤，避免跨用户访问。

## 数据与过滤
- 常见过滤键：`user_id`、`agent_id`、`run_id`、自定义业务键（如 `scene`、`trip`）。
- 建议为工具/阶段写入时附上 `agent_id` 与 `run_id`，便于后续分组查询与清理。

## 与智能体/工具的协作
- 阶段内检索：在生成回复前，先 `search` 获取与当前意图相关的用户记忆，作为系统消息增强上下文。
- 阶段后沉淀：将对话中的关键事实或用户偏好提取为消息写入 `memories`，利于后续阶段复用。
- 工具侧：通过 `get_memory_service()` 或 HTTP 调用统一访问，避免重复连接与配置散落。

## 调试与验证
- 本地启动依赖：`docker-compose up -d postgres redis qdrant`
- 本地运行 API：`uvicorn app.main:app --reload`
- 开启 Memory：`MEMORY_ENABLED=true` 并确保 Ollama/Qdrant 可用
- 一键验证脚本：`python scripts/test_memories.py`

## 常见问题
- 维度不匹配：更换嵌入模型需同步调整 `VECTOR_DIM`。
- 依赖超时：首启模型可能耗时较长，建议在 `scripts/wait_for_services.py` 基础上适当放宽等待时间。
- 退化路径：当 Redis 不可用或向量检索失败时，上层流程应允许“无记忆”继续执行，避免用户阻塞。

