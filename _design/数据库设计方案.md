# 完整数据库设计文档

> 针对：智能旅游 APP（以 **行程为导向** 、每个行程分为 `pre/on/post` 三阶段、伪多智能体协作）的 PostgreSQL 数据库方案（含向量检索支持、JSONB、索引、示例 DDL、常用查询、设计理由与运维建议）。文档力求可直接用作开发/建表/迁移的蓝本。

---

# 目录

1. 设计原则概述
2. 概念ER（实体与关系）概览
3. 关系表清单（字段、类型、约束、索引） — 主体部分
4. DDL（PostgreSQL）可执行建表语句（含扩展启用）
5. 常用查询示例（CRUD + 向量检索示例）
6. 模型与表之间的典型交互流程（API ↔ DB 映射）
7. 索引、性能、分区、缓存建议
8. 隐私/合规/备份/保留策略建议
9. 可扩展性与演进要点（多租户、审计、历史数据）
10. 部署与迁移注意事项

---

# 1）设计原则（简短）

* **以行程（Trip）为主轴** ，用户拥有多个行程，每个行程包含阶段（stage）、日程项、任务、会话与KB条目引用。
* **数据可审计** （所有 agent/user 的对话与关键确认都被记录）。
* **半结构化支持** ：使用 `JSONB` 存放不规则字段（工具输出、第三方 API 返回、meta）。
* **向量检索** ：保存 embeddings（pgvector）以支持语义检索（KB、历史对话、相似行程）。
* **业务可扩展** ：表设计支持增加 agent、工具、外部资源等。
* 以 **PostgreSQL** 为主（丰富 JSON 支持、扩展生态：pgvector、postgis 等）。

---

# 2）概念ER（实体与关系）概览

主要实体：

* `users` — 用户
* `trips` — 行程（主轴）
* `trip_stages` — 行程阶段（pre/on/post）
* `itinerary_items` — 日程项（景点/酒店/航班/餐厅/交通）
* `tasks` — 待办事项（booking、准备清单）
* `conversations` — 聊天记录（按阶段）
* `kb_entries` — 知识库条目（可向量化）
* `user_tags` — 用户偏好标签（由 post-agent 抽取）
* `agents` — 可选：注册的 agent 定义/能力（便于扩展）
* `external_resources` — 外部来源/链接（供追溯）
* `audit_logs` — 操作审计（可选）

关系举例：

* `users` 1 : N `trips`
* `trips` 1 : N `trip_stages`（通常固定 3 条）
* `trips` 1 : N `itinerary_items`
* `trips` 1 : N `tasks`
* `trips` 1 : N `conversations`
* `users` 1 : N `user_tags`
* `kb_entries` 可以关联 `trip_id`（来源）或独立存在

简易 ASCII ER：

```
users ──< trips ──< trip_stages
            ├─< itinerary_items
            ├─< tasks
            └─< conversations
kb_entries ──< (optional link to trips)
user_tags ──< users
agents (catalog)
```

---

# 3）关系表详细设计（字段 / 类型 / 说明 / 索引）

> 以下字段以 PostgreSQL 类型为准 (`timestamp with time zone` = `timestamptz`)。列出主键、外键、重要索引与 JSONB 字段。

---

### 表：`users`

保存用户基本信息与认证相关（可与已有 auth 系统集成）

```text
users
- id             : BIGSERIAL PRIMARY KEY
- username       : VARCHAR(64) NOT NULL UNIQUE
- email          : VARCHAR(255) UNIQUE
- password_hash  : TEXT
- display_name   : VARCHAR(128)
- locale         : VARCHAR(8)         -- e.g. 'zh-CN'
- created_at     : timestamptz DEFAULT now()
- updated_at     : timestamptz DEFAULT now()
- meta           : JSONB DEFAULT '{}'  -- 可存 mobile info, settings
```

索引：

* `UNIQUE(username)`, `UNIQUE(email)`（条件允许）

备注：如使用第三方 OAuth，可用 `auth_providers` 表存放映射。

---

### 表：`trips`

行程主表（每个用户的行程空间）

```text
trips
- id                : BIGSERIAL PRIMARY KEY
- user_id           : BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE
- title             : VARCHAR(255)   -- e.g. "成都周末游"
- origin            : VARCHAR(255)   -- 文本地址或城市名
- origin_lat        : DOUBLE PRECISION
- origin_lng        : DOUBLE PRECISION
- destination       : VARCHAR(255)
- destination_lat   : DOUBLE PRECISION
- destination_lng   : DOUBLE PRECISION
- start_date        : DATE
- duration_days     : INT
- budget            : NUMERIC(10,2)  -- 本次行程预算
- currency          : VARCHAR(8) DEFAULT 'CNY'
- current_stage     : trip_stage_enum DEFAULT 'pre'  -- enum('pre','on','post')
- status            : VARCHAR(32) DEFAULT 'active'   -- active, archived, cancelled
- created_at        : timestamptz DEFAULT now()
- updated_at        : timestamptz DEFAULT now()
- meta              : JSONB DEFAULT '{}' -- 保存额外设置
```

索引：

* `INDEX (user_id)`
* `INDEX (start_date)`
* 若常按 `user_id, current_stage` 查询，建复合索引 `(user_id, current_stage)`。

备注：`trip_stage_enum` 在 DDL 中定义为 enum。

---

### 表：`trip_stages`

每个 trip 的阶段记录（也可把阶段直接存在 trips.meta，但独立表便于状态与时间戳）

```text
trip_stages
- id             : BIGSERIAL PRIMARY KEY
- trip_id        : BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE
- stage_name     : VARCHAR(8) NOT NULL     -- 'pre', 'on', 'post'
- status         : VARCHAR(16) DEFAULT 'pending' -- pending,in_progress,completed
- assigned_agent : VARCHAR(128)            -- e.g. 'pre_agent_v1'
- confirmed_at   : timestamptz
- created_at     : timestamptz DEFAULT now()
- updated_at     : timestamptz DEFAULT now()
- meta           : JSONB DEFAULT '{}'      -- e.g. tool outputs, step counts
```

索引：

* `INDEX (trip_id, stage_name)`（唯一性约束可视需求：一个 trip 一阶段只有一条记录）

可加唯一约束：

`UNIQUE (trip_id, stage_name)`

---

### 表：`itinerary_items`

日程细项（景点/酒店/航班/餐厅/交通）

```text
itinerary_items
- id             : BIGSERIAL PRIMARY KEY
- trip_id        : BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE
- day             : INT   -- 从 1 开始
- start_time      : TIME
- end_time        : TIME
- kind            : VARCHAR(32) NOT NULL -- 'attraction','hotel','flight','restaurant','transport'
- title           : VARCHAR(255)
- description     : TEXT
- location        : VARCHAR(512)
- lat             : DOUBLE PRECISION
- lng             : DOUBLE PRECISION
- order_index     : INT DEFAULT 0   -- 页面排序
- created_at      : timestamptz DEFAULT now()
- updated_at      : timestamptz DEFAULT now()
- details         : JSONB DEFAULT '{}' -- 例如航班号、预订信息、价格、source_link
```

索引：

* `INDEX (trip_id, day, order_index)`

---

### 表：`tasks`

用于 Pre-trip 的待办清单或 On-trip 的任务（可被用户 mark done）

```text
tasks
- id             : BIGSERIAL PRIMARY KEY
- trip_id        : BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE
- stage          : VARCHAR(8) NOT NULL -- 'pre','on','post'
- title          : VARCHAR(255)
- description    : TEXT
- status         : VARCHAR(16) DEFAULT 'todo' -- todo,done,skipped
- priority       : INT DEFAULT 0
- assigned_to    : VARCHAR(64) -- 'user' / 'agent'
- due_date       : DATE
- created_at     : timestamptz DEFAULT now()
- updated_at     : timestamptz DEFAULT now()
- meta           : JSONB DEFAULT '{}'  -- e.g. external link
```

索引：

* `INDEX (trip_id, stage, status)`

---

### 表：`conversations`

保存用户与各 stage-agent 的对话（关键审计数据）

```text
conversations
- id             : BIGSERIAL PRIMARY KEY
- trip_id        : BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE
- stage          : VARCHAR(8) NOT NULL -- 'pre','on','post'
- role           : VARCHAR(16) NOT NULL -- 'user' or 'agent' or 'system'
- message        : TEXT NOT NULL
- message_meta   : JSONB DEFAULT '{}' -- tools_called, tool_outputs, source_links
- embedding_id    : BIGINT NULL     -- 可选：引用 embedding 存储表
- created_at     : timestamptz DEFAULT now()
```

索引：

* `INDEX (trip_id, stage, created_at DESC)`
* 若经常全文检索可用 `GIN` 在 `message` 上（但注意成本）

备注：对话也需出于隐私考虑做保留策略。

---

### 表：`kb_entries`

知识库：既存知识（景点说明、FAQ、工具输出）用于向量检索和回溯

```text
kb_entries
- id             : BIGSERIAL PRIMARY KEY
- trip_id        : BIGINT NULL REFERENCES trips(id) ON DELETE SET NULL  -- 来源（可NULL）
- source         : VARCHAR(255)   -- 'openweb','user_confirm','manual','api'
- title          : VARCHAR(255)
- content        : TEXT NOT NULL
- metadata       : JSONB DEFAULT '{}' -- tags, url, author, lang
- embedding      : VECTOR(1536)   -- pgvector 类型（向量维度按模型决定）
- created_at     : timestamptz DEFAULT now()
- updated_at     : timestamptz DEFAULT now()
```

索引：

* `ivfflat` 或 `hnsw` 索引（pgvector 提供）：
  * `CREATE INDEX ON kb_entries USING ivfflat (embedding) WITH (lists=100);`
* `GIN` 索引 on `metadata` (`jsonb_path_ops`)

备注：embedding 维度示例用 1536（OpenAI text-embedding-3-large）；可按成本选 768/1024/1536 等。

---

### 表：`user_tags`

Post-trip 从总结中抽取的偏好标签（用于个性化推荐）

```text
user_tags
- id            : BIGSERIAL PRIMARY KEY
- user_id       : BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE
- tag           : VARCHAR(128) NOT NULL -- 'museum','becareful_with_long_walks'
- weight        : FLOAT DEFAULT 1.0
- source_trip_id: BIGINT NULL REFERENCES trips(id)
- created_at    : timestamptz DEFAULT now()
```

索引：

* `INDEX (user_id)`, `INDEX (tag)`

---

### 表：`agents`（可选）

记录 agent 的元信息（便于版本管理 / A/B 测试）

```text
agents
- id           : BIGSERIAL PRIMARY KEY
- name         : VARCHAR(128) UNIQUE
- version      : VARCHAR(64)
- system_prompt: TEXT
- tools        : JSONB  -- 可用工具清单
- created_at   : timestamptz DEFAULT now()
```

---

### 表：`external_resources`（可选）

存储外部链接与快照证据（有助于溯源）

```text
external_resources
- id           : BIGSERIAL PRIMARY KEY
- trip_id      : BIGINT NULL REFERENCES trips(id)
- url          : TEXT
- title        : VARCHAR(255)
- snapshot     : JSONB   -- cached response or metadata
- created_at   : timestamptz DEFAULT now()
```

---

### 表：`audit_logs`（可选，合规/审计）

记录关键操作（例如 stage 状态变更、预订确认）

```text
audit_logs
- id           : BIGSERIAL PRIMARY KEY
- user_id      : BIGINT NULL REFERENCES users(id)
- trip_id      : BIGINT NULL REFERENCES trips(id)
- action       : VARCHAR(128) -- e.g. 'trip_stage_changed','task_completed'
- detail       : JSONB
- created_at   : timestamptz DEFAULT now()
```

---

# 4）PostgreSQL DDL（可直接执行的建表语句示例）

> 假设使用 PostgreSQL >= 14，且已安装 `pgvector` 扩展。下面给出核心表的 DDL 示例（已考虑约束与索引）。在真实工程中把 enum 换成 lookup 表也可。

```sql
-- 0. 必要扩展
CREATE EXTENSION IF NOT EXISTS "pgvector";

-- 1. ENUM 类型（也可以使用 VARCHAR）
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'trip_stage_enum') THEN
    CREATE TYPE trip_stage_enum AS ENUM ('pre','on','post');
  END IF;
END$$;

-- 2. users
CREATE TABLE users (
  id BIGSERIAL PRIMARY KEY,
  username VARCHAR(64) NOT NULL UNIQUE,
  email VARCHAR(255),
  password_hash TEXT,
  display_name VARCHAR(128),
  locale VARCHAR(8),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  meta JSONB DEFAULT '{}' 
);

-- 3. trips
CREATE TABLE trips (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255),
  origin VARCHAR(255),
  origin_lat DOUBLE PRECISION,
  origin_lng DOUBLE PRECISION,
  destination VARCHAR(255),
  destination_lat DOUBLE PRECISION,
  destination_lng DOUBLE PRECISION,
  start_date DATE,
  duration_days INT,
  budget NUMERIC(10,2),
  currency VARCHAR(8) DEFAULT 'CNY',
  current_stage trip_stage_enum DEFAULT 'pre',
  status VARCHAR(32) DEFAULT 'active',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  meta JSONB DEFAULT '{}'
);
CREATE INDEX idx_trips_user ON trips(user_id);
CREATE INDEX idx_trips_start_date ON trips(start_date);
CREATE INDEX idx_trips_user_stage ON trips(user_id, current_stage);

-- 4. trip_stages
CREATE TABLE trip_stages (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  stage_name VARCHAR(8) NOT NULL,
  status VARCHAR(16) DEFAULT 'pending',
  assigned_agent VARCHAR(128),
  confirmed_at timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  meta JSONB DEFAULT '{}',
  UNIQUE (trip_id, stage_name)
);
CREATE INDEX idx_trip_stages_trip ON trip_stages(trip_id);

-- 5. itinerary_items
CREATE TABLE itinerary_items (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  day INT,
  start_time TIME,
  end_time TIME,
  kind VARCHAR(32) NOT NULL,
  title VARCHAR(255),
  description TEXT,
  location VARCHAR(512),
  lat DOUBLE PRECISION,
  lng DOUBLE PRECISION,
  order_index INT DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  details JSONB DEFAULT '{}'
);
CREATE INDEX idx_itinerary_trip_day ON itinerary_items(trip_id, day, order_index);

-- 6. tasks
CREATE TABLE tasks (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  stage VARCHAR(8) NOT NULL,
  title VARCHAR(255),
  description TEXT,
  status VARCHAR(16) DEFAULT 'todo',
  priority INT DEFAULT 0,
  assigned_to VARCHAR(64),
  due_date DATE,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  meta JSONB DEFAULT '{}'
);
CREATE INDEX idx_tasks_trip_stage_status ON tasks(trip_id, stage, status);

-- 7. conversations
CREATE TABLE conversations (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  stage VARCHAR(8) NOT NULL,
  role VARCHAR(16) NOT NULL,
  message TEXT NOT NULL,
  message_meta JSONB DEFAULT '{}',
  embedding_id BIGINT,
  created_at timestamptz DEFAULT now()
);
CREATE INDEX idx_conv_trip_stage_created ON conversations(trip_id, stage, created_at DESC);

-- 8. kb_entries (with pgvector)
CREATE TABLE kb_entries (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT REFERENCES trips(id) ON DELETE SET NULL,
  source VARCHAR(255),
  title VARCHAR(255),
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  embedding vector(1536), -- 请根据你用的 embedding 模型维度设置
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
-- 向量索引（示例使用 ivfflat，注意需要先做 REINDEX after insert or set 'lists' based on dataset）
CREATE INDEX idx_kb_embedding_ivf ON kb_entries USING ivfflat (embedding) WITH (lists = 100);
CREATE INDEX idx_kb_metadata_gin ON kb_entries USING gin (metadata jsonb_path_ops);

-- 9. user_tags
CREATE TABLE user_tags (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  tag VARCHAR(128) NOT NULL,
  weight FLOAT DEFAULT 1.0,
  source_trip_id BIGINT REFERENCES trips(id),
  created_at timestamptz DEFAULT now()
);
CREATE INDEX idx_user_tags_user ON user_tags(user_id);

-- 10. agents (optional)
CREATE TABLE agents (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(128) UNIQUE,
  version VARCHAR(64),
  system_prompt TEXT,
  tools JSONB DEFAULT '{}',
  created_at timestamptz DEFAULT now()
);

-- 11. external_resources (optional)
CREATE TABLE external_resources (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT REFERENCES trips(id),
  url TEXT,
  title VARCHAR(255),
  snapshot JSONB DEFAULT '{}',
  created_at timestamptz DEFAULT now()
);

-- 12. audit_logs (optional)
CREATE TABLE audit_logs (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id),
  trip_id BIGINT REFERENCES trips(id),
  action VARCHAR(128),
  detail JSONB DEFAULT '{}',
  created_at timestamptz DEFAULT now()
);
```

---

# 5）常用查询示例（SQL）

#### 创建行程（并自动创建 3 个阶段记录）

```sql
BEGIN;
INSERT INTO trips (user_id, title, origin, destination, start_date, duration_days, budget)
VALUES (1, '成都周末游','北京','成都','2025-11-20',3,1500)
RETURNING id;
-- 假设返回 id = 123
INSERT INTO trip_stages (trip_id, stage_name, status) VALUES
(123,'pre','in_progress'), (123,'on','pending'), (123,'post','pending');
COMMIT;
```

#### 获取某用户的所有行程及 stage 状态

```sql
SELECT t.*, ts.stage_name, ts.status
FROM trips t
LEFT JOIN trip_stages ts ON ts.trip_id = t.id
WHERE t.user_id = 1
ORDER BY t.start_date DESC;
```

#### 查询某行程的日程（按天排序）

```sql
SELECT * FROM itinerary_items
WHERE trip_id = 123
ORDER BY day ASC, order_index ASC;
```

#### 保存对话并返回 agent 回复（伪示例）

（后端先写入用户消息，再把生成的 agent 回复写入）

```sql
INSERT INTO conversations (trip_id, stage, role, message, message_meta)
VALUES (123, 'pre', 'user', '帮我安排酒店', '{"source":"web"}');

-- agent 回复:
INSERT INTO conversations (trip_id, stage, role, message, message_meta)
VALUES (123, 'pre', 'agent', '推荐三家酒店：A/B/C...', '{"tools":["hotel_search"]}');
```

#### 向量相似度检索（pgvector，找最相似的 top 5）

```sql
-- 假设 query_embedding 为长度 1536 的向量
SELECT id, title, content, 1 - (embedding <=> query_embedding::vector) AS similarity
FROM kb_entries
ORDER BY embedding <=> query_embedding::vector
LIMIT 5;
```

> 说明：`<=>` 是 pgvector 的距离操作符（内积/欧氏等按配置），更多细节参见 pgvector 文档。

---

# 6）API ↔ DB 映射（常用端点与对应表）

* `POST /api/trips` → `INSERT trips` + 初始化 `trip_stages`
* `GET  /api/trips/{id}` → SELECT trips + trip_stages + itinerary_items + tasks
* `PATCH /api/trips/{id}/stage` → 更新 `trip_stages` 和 `trips.current_stage`
* `GET  /api/trips/{id}/assistant/{stage}/chat` → SELECT `conversations`
* `POST /api/trips/{id}/assistant/{stage}/chat` → INSERT conversation（user）→ 调 LLM → INSERT conversation（agent）→ 若 agent 触发任务/itinerary 变更，则更新 `tasks`/`itinerary_items`/`trip_stages`
* `GET  /api/kb/search?q=` → 向量检索 `kb_entries` + filter metadata
* `POST /api/trips/{id}/tasks/{task_id}/complete` → UPDATE `tasks` → INSERT `audit_logs`

---

# 7）索引 / 性能 / 分区建议

* 对常查字段建索引：`user_id`、`trip_id`、`start_date`、`(user_id, current_stage)`。
* `conversations` 体量会增长快：考虑按 `trip_id` 分区或按 `created_at` 时间范围分区（monthly）。
* `kb_entries.embedding` 使用 pgvector 的 ANN 索引（ivfflat/hnsw），注意：
  * ivfflat 在大量向量时效果好，但插入后需 `REINDEX` 或 `ANN` 的 `lists` 参数调整。
  * hnsw 插入速度慢但检索质量好（pgvector 支持 hnsw 在新版）。
* `JSONB` 字段上用 `GIN` 索引（`jsonb_path_ops`）以加速 metadata 查询。
* 热点数据（当前进行中的 trips、最近会话）可缓存到 Redis（expiration 1-5 min），避免频繁查询 DB。
* 批量插入 embeddings 时使用批量 INSERT，并关闭自动索引刷新（视具体索引类型）。

---

# 8）隐私 / 合规 / 备份策略

* **最小化保存定位数据** ：仅在用户允许时保存 `lat/lng`；若非必要可只存城市级别文本。
* **数据保留策略** ：
* 会话（conversations）建议保留 1–3 年（学校要求），可定期归档到冷存储。
* 对敏感日志（password_hash 之外）加密或按需脱敏。
* **备份** ：每日增量备份 + 每周全量备份。备份存储应为异地（S3/对象存储），并启用加密。
* **审计** ：重要变更（预订确认、支付）记录到 `audit_logs`（不可篡改的 append-only，定期导出）。
* **合规** ：如果要处理支付/身份证号/签证信息，遵守相应法律（不建议在本科项目中存储身份证号等敏感 PII）。

---

# 9）可扩展性与未来演进建议

* **多模型 / 多 agent 版本管理** ：用 `agents` 表保存 system prompts 与版本。服务端可按 `agent_id` 路由到不同 prompt。
* **多租户设计** （若有公司/学校多账号）：为 `users` 加 org_id；或在 `trips` 上加 `tenant_id`。
* **审计与回滚** ：对关键表启用 `history`（例如 `trips_history`）或使用 triggers 自动记录变更快照。
* **搜索增强** ：为 `itinerary_items.title/description` 启用全文检索（Postgres `tsvector`）以便快速文本搜索。
* **地理空间** ：如需路线计算，考虑添加 PostGIS，使用 geometry 类型存储位置与路线。

---

# 10）部署与迁移注意事项（开发到生产）

* 在本地开发使用 `docker-compose`：Postgres + pgvector 插件镜像（如 postgres:15 + pgvector extension）。
* 使用 Alembic 管理 schema 变更（把上面 DDL 转为 migration 脚本）。
* 在导入大量历史 KB 入库时：先关闭索引或使用 bulk insert，再创建/refresh ANN 索引以提高速度。
* 建议在表上设置合理的 `vacuum` 策略与监控（large tables、frequent updates）。
* 监控：慢查询日志、表膨胀、向量索引大小、磁盘空间、连接数。

---

# 附：示例初始 seed 数据（用于 demo）

```sql
INSERT INTO users (username, email, display_name) VALUES ('xhy','xhy@example.com','徐浩焱');

-- 创建示例 trip + stages (事务)
BEGIN;
INSERT INTO trips (user_id, title, origin, destination, start_date, duration_days, budget)
VALUES (1, '成都周末游','北京','成都','2025-11-20',3,1500)
RETURNING id;
-- 假设 id = 1
INSERT INTO trip_stages (trip_id, stage_name, status) VALUES (1,'pre','in_progress'), (1,'on','pending'), (1,'post','pending');
COMMIT;

-- 一个 KB 示例（embedding 需通过后端生成并更新）
INSERT INTO kb_entries (trip_id, source, title, content, metadata) VALUES
(1,'manual','宽窄巷子介绍','宽窄巷子是成都市区著名历史街区...', '{"category":"attraction","city":"成都"}');
```

---

# 总结与建议（实施优先级）

短期（MVP）应优先实现并验证：

1. `users`、`trips`、`trip_stages`、`conversations`、`tasks`、`itinerary_items`、`kb_entries`（简化 embedding 字段可先为空）
2. 对话保存流程 + 将用户确认写入 `tasks` / `trip_stages`（确保状态机一致）
3. kb_entries 的 embeddings pipeline（后端生成并写入）与简单语义检索（top-k）
4. 简单的索引（user/trip）与 Redis 缓存近期对话/行程

中期（进阶）：

* 启用 pgvector 索引、分区 `conversations`、审计日志与备份策略
* 增加全文搜索、PostGIS（如果做路线优化）

---

如果你愿意，我可以下一步：

* 把这份 DDL 转为 **Alembic migration** 模板（Python 脚本），或
* 生成对应的  **SQLAlchemy / Pydantic 模型** （可直接放进 FastAPI 项目），或
* 画一张 ER 图（可下载 SVG）以便放在答辩 PPT 中。

你想先要哪一种？
